<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quản lý Location</title>
</head>
<body>
  <h2>Danh sách Location</h2>
  <ul id="locationList"></ul>

  <h3>Thêm / Sửa Location</h3>
  <input type="text" id="Code" placeholder="Code" />
  <input type="text" id="Name" placeholder="Name" />
  <button onclick="addOrUpdate()">Thêm / Cập nhật</button>
  <button onclick="clearForm()">Xoá trắng</button>

  <script>
    const dbName = "MyDatabase";
    const storeName = "location";
    let db;

    // Khởi tạo DB
    const request = indexedDB.open(dbName, 1);
    request.onupgradeneeded = function (event) {
      db = event.target.result;
      if (!db.objectStoreNames.contains(storeName)) {
        db.createObjectStore(storeName, { keyPath: "Code" });
      }
    };

    request.onsuccess = function (event) {
      db = event.target.result;

      // Nếu store trống thì load từ JSON
      const tx = db.transaction(storeName, "readonly");
      const store = tx.objectStore(storeName);
      const countRequest = store.count();
      countRequest.onsuccess = function () {
        if (countRequest.result === 0) {
          fetch('location.json')
            .then(response => response.json())
            .then(data => {
              const writeTx = db.transaction(storeName, "readwrite");
              const writeStore = writeTx.objectStore(storeName);
              data.forEach(item => writeStore.put(item));
              writeTx.oncomplete = displayData;
            });
        } else {
          displayData();
        }
      };
    };

    function displayData() {
      const ul = document.getElementById("locationList");
      ul.innerHTML = "";
      const tx = db.transaction(storeName, "readonly");
      const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = function () {
        req.result.forEach(loc => {
          const li = document.createElement("li");
          li.innerHTML = `
            <strong>${loc.Code}</strong>: ${loc.Name}
            <button onclick="edit('${loc.Code}')">Sửa</button>
            <button onclick="remove('${loc.Code}')">Xóa</button>
          `;
          ul.appendChild(li);
        });
      };
    }

    function addOrUpdate() {
      const code = document.getElementById("Code").value.trim();
      const name = document.getElementById("Name").value.trim();
      if (!code || !name) return alert("Nhập đầy đủ Code và Name");

      const tx = db.transaction(storeName, "readwrite");
      const store = tx.objectStore(storeName);
      store.put({ Code: Code, Name: Name });
      tx.oncomplete = () => {
        clearForm();
        displayData();
      };
    }

    function edit(code) {
      const tx = db.transaction(storeName, "readonly");
      const store = tx.objectStore(storeName);
      const req = store.get(code);
      req.onsuccess = function () {
        if (req.result) {
          document.getElementById("Code").value = req.result.Code;
          document.getElementById("Name").value = req.result.Name;
        }
      };
    }

    function remove(code) {
      if (!confirm("Xóa bản ghi này?")) return;
      const tx = db.transaction(storeName, "readwrite");
      const store = tx.objectStore(storeName);
      store.delete(code);
      tx.oncomplete = displayData;
    }

    function clearForm() {
      document.getElementById("Code").value = "";
      document.getElementById("Name").value = "";
    }
  </script>
</body>
</html>
